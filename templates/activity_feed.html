<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=.8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Activity Feed - Libaraxia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
</head>

<body class="bg-primary text-content-primary p-6">
    {% include '_sidebar.html' %}

    <!-- Flash Messages -->
    {% include '_flash_messages.html' %}

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20">
        <!-- Page Header -->
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-display font-bold text-content-primary mb-2">Activity Feed</h1>
            <p class="text-content-secondary">What are other users doing?</p>
        </div>

        <!-- Activity Feed -->
        <div class="space-y-6">
            {% if activities %}
                {% for activity in activities %}
                    <div class="bg-secondary rounded-lg shadow-md p-6 pb-16 hover:shadow-xl transition-shadow relative">
                        <!-- Action buttons in top right -->
                        <div class="absolute top-4 right-4 flex gap-3 items-center">
                            <!-- Dismiss button (only for user's own activities) -->
                            {% if activity.user_id == current_user.id %}
                            <form method="POST" action="/feed/dismiss_activity" class="inline" onsubmit="return confirm('Are you sure you want to dismiss this activity from the feed? This will hide it for all users.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="activity_type" value="{{ activity.type }}">
                                <input type="hidden" name="book_id" value="{{ activity.book_id }}">
                                <input type="hidden" name="user_id" value="{{ activity.user_id }}">
                                <button type="submit" class="text-content-secondary hover:text-yellow-500 transition-colors" title="Dismiss from feed">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18.36 6L6 18.36M6 6l12.36 12.36"></path>
                                    </svg>
                                </button>
                            </form>
                            {% endif %}
                        </div>

                        <div class="flex gap-4">
                            <!-- Book Cover -->
                            <div class="flex-shrink-0">
                                <a href="/books/book/{{ activity.book_id }}">
                                    {% if activity.cover_image_url %}
                                        <img src="{{ url_for('static', filename=activity.cover_image_url) }}"
                                             alt="{{ activity.title }}"
                                             class="w-24 h-36 object-cover rounded-lg shadow-md">
                                    {% else %}
                                        <div class="w-24 h-36 bg-accent/20 rounded-lg flex items-center justify-center">
                                            <svg class="w-12 h-12 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                            </svg>
                                        </div>
                                    {% endif %}
                                </a>
                            </div>

                            <!-- Activity Details -->
                            <div class="flex-grow">
                                {% if activity.type == 'book_added' %}
                                    <!-- New Book Activity -->
                                    <div class="flex items-start gap-2 mb-2">
                                        <svg class="w-5 h-5 text-accent mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 5v14m7-7H5"></path>
                                        </svg>
                                        <div>
                                            <p class="text-content-primary font-semibold">
                                                {% if activity.username %}
                                                    <a href="/user/{{ activity.username }}" class="hover:text-accent transition-colors">
                                                        {{ activity.username }}
                                                    </a>
                                                    added a new book
                                                {% else %}
                                                    New Book Added
                                                {% endif %}
                                            </p>
                                            <p class="text-content-secondary text-sm">{{ activity.date }}</p>
                                        </div>
                                    </div>

                                    <a href="/books/book/{{ activity.book_id }}"
                                       class="block hover:text-accent transition-colors">
                                        <h3 class="text-xl font-semibold text-content-primary mb-1">
                                            {{ activity.title }}
                                        </h3>
                                        <p class="text-content-secondary mb-2">by {{ activity.author }}</p>
                                    </a>

                                {% elif activity.type == 'wishlist_added' %}
                                    <!-- Wishlist Activity -->
                                    <div class="flex items-start gap-2 mb-2">
                                        <svg class="w-5 h-5 text-purple-500 mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-content-primary font-semibold">
                                                <a href="/user/{{ activity.username }}" class="hover:text-accent transition-colors">
                                                    {{ activity.username }}
                                                </a>
                                                added to wishlist
                                            </p>
                                            <p class="text-content-secondary text-sm">{{ activity.date }}</p>
                                        </div>
                                    </div>

                                    <a href="/books/book/{{ activity.book_id }}"
                                       class="block hover:text-accent transition-colors">
                                        <h3 class="text-xl font-semibold text-content-primary mb-1">
                                            {{ activity.title }}
                                        </h3>
                                        <p class="text-content-secondary mb-2">by {{ activity.author }}</p>
                                    </a>

                                {% elif activity.type == 'collection_added' %}
                                    <!-- Collection Status Activity -->
                                    <div class="flex items-start gap-2 mb-2">
                                        <svg class="w-5 h-5 text-blue-500 mt-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-content-primary font-semibold">
                                                <a href="/user/{{ activity.username }}" class="hover:text-accent transition-colors">
                                                    {{ activity.username }}
                                                </a>
                                                {% if activity.status == 'currently reading' %}
                                                    started reading
                                                {% elif activity.status == 'want to read' %}
                                                    wants to read
                                                {% else %}
                                                    added to library
                                                {% endif %}
                                            </p>
                                            <p class="text-content-secondary text-sm">{{ activity.date }}</p>
                                        </div>
                                    </div>

                                    <a href="/books/book/{{ activity.book_id }}"
                                       class="block hover:text-accent transition-colors">
                                        <h3 class="text-xl font-semibold text-content-primary mb-1">
                                            {{ activity.title }}
                                        </h3>
                                        <p class="text-content-secondary">by {{ activity.author }}</p>
                                    </a>

                                {% elif activity.type == 'review_added' %}
                                    <!-- Review Activity -->
                                    <div class="flex items-start gap-2 mb-2">
                                        <svg class="w-5 h-5 text-yellow-500 mt-1" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                        </svg>
                                        <div>
                                            <p class="text-content-primary font-semibold">
                                                <a href="/user/{{ activity.username }}" class="hover:text-accent transition-colors">
                                                    {{ activity.username }}
                                                </a>
                                                reviewed a book
                                            </p>
                                            <p class="text-content-secondary text-sm">{{ activity.date }}</p>
                                        </div>
                                    </div>

                                    <a href="/books/book/{{ activity.book_id }}"
                                       class="block hover:text-accent transition-colors mb-3">
                                        <h3 class="text-xl font-semibold text-content-primary mb-1">
                                            {{ activity.title }}
                                        </h3>
                                        <p class="text-content-secondary">by {{ activity.author }}</p>
                                    </a>

                                    {% if activity.rating %}
                                        <div class="flex items-center gap-1 mb-2">
                                            {% for i in range(5) %}
                                                {% if i < activity.rating %}
                                                    <svg class="w-5 h-5 text-yellow-500" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                                    </svg>
                                                {% else %}
                                                    <svg class="w-5 h-5 text-content-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                                    </svg>
                                                {% endif %}
                                            {% endfor %}
                                            <span class="ml-2 text-content-secondary">{{ activity.rating }}/5</span>
                                        </div>
                                    {% endif %}

                                    {% if activity.comment %}
                                        <div class="bg-primary/50 rounded-lg p-4 mt-3">
                                            <p class="text-content-primary italic">"{{ activity.comment }}"</p>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Like button in bottom right corner (for all activity types) -->
                        <div class="absolute bottom-6 right-6 z-10">
                            {% if activity.user_id != current_user.id %}
                            <button
                                onclick="toggleLike('{{ activity.type }}', {{ activity.book_id | tojson }}, {{ activity.user_id | tojson }}, this)"
                                class="like-button flex items-center gap-1 text-content-secondary hover:text-red-500 transition-colors"
                                data-liked="{{ 'true' if activity.user_liked else 'false' }}"
                                title="{{ 'Unlike' if activity.user_liked else 'Like' }}">
                                <svg class="w-5 h-5 {{ 'fill-red-500 text-red-500' if activity.user_liked else 'fill-none' }}"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor"
                                     stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span class="like-count text-sm">{{ activity.like_count if activity.like_count > 0 else '' }}</span>
                            </button>
                            {% else %}
                            <!-- Show like count for own activities (non-clickable) -->
                            {% if activity.like_count > 0 %}
                            <div class="flex items-center gap-1 text-content-secondary">
                                <svg class="w-5 h-5 fill-red-500 text-red-500"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor"
                                     stroke-width="2">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                                <span class="text-sm">{{ activity.like_count }}</span>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-12">
                    <svg class="w-24 h-24 mx-auto mb-4 text-content-secondary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <p class="text-xl text-content-secondary">No activity yet</p>
                    <p class="text-content-secondary mt-2">Start adding books and reviews to see your activity feed!</p>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- End Main Container -->

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        async function toggleLike(activityType, bookId, activityUserId, button) {
            const isLiked = button.dataset.liked === 'true';
            const endpoint = isLiked ? '/feed/unlike_activity' : '/feed/like_activity';

            // Get CSRF token from meta tag or form
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value ||
                              document.querySelector('meta[name="csrf-token"]')?.content;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        activity_type: activityType,
                        book_id: bookId,
                        activity_user_id: activityUserId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Toggle the liked state
                    button.dataset.liked = isLiked ? 'false' : 'true';

                    // Update the heart icon
                    const svg = button.querySelector('svg');
                    if (isLiked) {
                        svg.classList.remove('fill-red-500', 'text-red-500');
                        svg.classList.add('fill-none');
                        button.title = 'Like';
                    } else {
                        svg.classList.remove('fill-none');
                        svg.classList.add('fill-red-500', 'text-red-500');
                        button.title = 'Unlike';
                    }

                    // Update the like count
                    const likeCountSpan = button.querySelector('.like-count');
                    likeCountSpan.textContent = data.like_count > 0 ? data.like_count : '';
                } else {
                    console.error('Error toggling like:', data.error);
                    if (data.error === 'Cannot like your own activity') {
                        alert('You cannot like your own activity!');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            }
        }
    </script>
</body>
</html>
