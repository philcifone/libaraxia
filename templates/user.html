<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=.8">
    <title>User Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <style>
        .tab-button.active {
            border-bottom: 3px solid #4f7d19;
            background-color: rgba(79, 125, 25, 0.1);
        }
    </style>
</head>
<body class="bg-primary dark:bg-primary light:bg-primary-light min-h-screen">
    {% include '_sidebar.html' %}

    <!-- Flash Messages -->
    {% include '_flash_messages.html' %}

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto pt-20 pb-8 px-4 space-y-6">
        <!--Back Nav-->
        <a href="{{ url_for('base.index') }}" 
        class="inline-flex items-center text-content-secondary hover:text-accent transition-colors">
         <span class="mr-2">‚Üê</span>
         <span>Back to Catalog</span>
     </a>
        <!-- Profile Info -->
        <section class="bg-secondary rounded-xl p-4 shadow-lg">
            <div class="flex items-center gap-4 p-4">
                <!-- Avatar with Upload on Hover -->
                {% if current_user.id == user['id'] %}
                <div class="relative flex-shrink-0 flex items-center gap-2 group">
                    <div style="width: 64px; height: 64px;">
                        <label for="avatar-input" class="block w-full h-full cursor-pointer">
                            {% if user['avatar_url'] %}
                                <img id="avatar-image" src="{{ url_for('static', filename=user['avatar_url']) }}"
                                     alt="{{ user['username'] }}"
                                     class="w-full h-full rounded-full object-cover"
                                     style="width: 64px; height: 64px;">
                            {% else %}
                                <div id="avatar-placeholder" class="w-full h-full rounded-full bg-accent flex items-center justify-center text-3xl font-bold text-white"
                                     style="width: 64px; height: 64px;">
                                    {{ user['username'][0].upper() }}
                                </div>
                            {% endif %}
                        </label>
                        <input type="file" id="avatar-input" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" class="hidden" onchange="uploadAvatar(event)">
                    </div>
                    <label for="avatar-input" class="text-content-secondary hover:text-accent transition-colors opacity-0 group-hover:opacity-100 cursor-pointer" title="Change profile picture">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </label>
                    <!-- Simple loading text -->
                    <span id="avatar-upload-status" class="hidden text-sm text-accent">Uploading...</span>
                </div>
                {% else %}
                <div class="relative flex-shrink-0" style="width: 64px; height: 64px;">
                    {% if user['avatar_url'] %}
                        <img src="{{ url_for('static', filename=user['avatar_url']) }}"
                             alt="{{ user['username'] }}"
                             class="rounded-full object-cover"
                             style="width: 64px; height: 64px; min-width: 64px; min-height: 64px;">
                    {% else %}
                        <div class="rounded-full bg-accent flex items-center justify-center text-3xl font-bold text-white"
                             style="width: 64px; height: 64px;">
                            {{ user['username'][0].upper() }}
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="flex-1">
                    <h1 class="text-3xl font-display text-content-primary">
                        {{ user['username'].capitalize() }}'s Profile
                    </h1>

                    <!-- Friend Request Actions -->
                    {% if not is_own_profile %}
                    <div class="mt-3">
                        {% if friendship_status == 'friends' %}
                            <div class="flex items-center gap-2">
                                <form method="POST" action="{{ url_for('friends.remove_friend', friend_id=user['id']) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="text-xs text-content-secondary hover:text-red-500 transition-colors" onclick="return confirm('Remove {{ user['username'] }} from friends?')">
                                        Remove Friend
                                    </button>
                                </form>
                            </div>
                        {% elif friendship_status == 'request_sent' %}
                            <span class="text-sm text-content-secondary">Friend request sent</span>
                        {% elif friendship_status == 'request_received' %}
                            <div class="flex gap-2">
                                <form method="POST" action="{{ url_for('friends.accept_request', request_id=friend_request_id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition-colors">
                                        Accept Friend Request
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('friends.decline_request', request_id=friend_request_id) }}" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-sm transition-colors">
                                        Decline
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <form method="POST" action="{{ url_for('friends.send_request', username=user['username']) }}">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="px-4 py-2 bg-accent hover:bg-accent-hover text-white rounded transition-colors">
                                    Add Friend
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Bio Section -->
            {% if current_user.id == user['id'] or (user['bio'] and not is_own_profile) %}
            <div class="rounded-lg">
                {% if current_user.id == user['id'] %}
                <!-- Editable Bio for Own Profile -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <p class="text-sm uppercase tracking-wider text-content-secondary">Bio</p>
                        <button id="bio-edit-btn" class="text-content-secondary hover:text-accent transition-colors" onclick="editBio()" title="Edit bio">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="bio-display-container">
                        <p id="bio-display" class="text-content-primary whitespace-pre-wrap">{{ user['bio'] if user['bio'] else 'Add a bio to tell others about yourself...' }}</p>
                    </div>
                    <div id="bio-edit-container" class="hidden">
                        <textarea id="bio-input" class="w-full px-3 py-2 bg-secondary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent" rows="4" maxlength="500" placeholder="Tell others about yourself...">{{ user['bio'] if user['bio'] else '' }}</textarea>
                        <div class="flex items-center justify-between mt-2">
                            <span id="bio-char-count" class="text-xs text-content-secondary">0 / 500</span>
                            <div class="flex gap-2">
                                <button id="bio-save-btn" class="px-3 py-1 bg-accent hover:bg-accent-hover text-white rounded transition-colors" onclick="saveBio()">
                                    Save
                                </button>
                                <button id="bio-cancel-btn" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors" onclick="cancelBioEdit()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif user['bio'] %}
                <!-- Display Bio for Other Users -->
                <div class="space-y-2">
                    <p class="text-sm uppercase tracking-wider text-content-secondary">Bio</p>
                    <p class="text-content-primary whitespace-pre-wrap">{{ user['bio'] }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Privacy Notice for Non-Friends -->
            {% if not are_friends %}
            <div class="mt-4 p-2 bg-primary rounded border border-accent">
                <p class="text-sm text-content-secondary">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    This profile is private. Send a friend request to see {{ user['username'] }}'s reading activity.
                </p>
            </div>
            {% endif %}

            <div class="grid grid-cols-2 gap-6 mt-6">
                {% if current_user.id == user['id'] %}
                <!-- Email (Editable) -->
                <div class="space-y-2">
                    <p class="text-sm uppercase tracking-wider text-content-secondary">Email</p>
                    <div class="flex items-center gap-2 group">
                        <p id="email-display" class="text-content-primary">{{ user['email'] }}</p>
                        <input type="email" id="email-input" class="hidden flex-1 px-3 py-1 bg-primary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent" value="{{ user['email'] }}">
                        <button id="email-edit-btn" class="text-content-secondary hover:text-accent transition-colors opacity-0 group-hover:opacity-100" onclick="editField('email')" title="Edit email">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                        <button id="email-save-btn" class="hidden text-accent hover:text-accent-hover transition-colors" onclick="saveField('email')" title="Save">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </button>
                        <button id="email-cancel-btn" class="hidden text-red-500 hover:text-red-600 transition-colors" onclick="cancelEdit('email')" title="Cancel">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Username (Editable) -->
                <div class="space-y-2">
                    <p class="text-sm uppercase tracking-wider text-content-secondary">Username</p>
                    <div class="flex items-center gap-2 group">
                        <p id="username-display" class="text-content-primary">{{ user['username'] }}</p>
                        <input type="text" id="username-input" class="hidden flex-1 px-3 py-1 bg-primary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent" value="{{ user['username'] }}">
                        <button id="username-edit-btn" class="text-content-secondary hover:text-accent transition-colors opacity-0 group-hover:opacity-100" onclick="editField('username')" title="Edit username">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                        <button id="username-save-btn" class="hidden text-accent hover:text-accent-hover transition-colors" onclick="saveField('username')" title="Save">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </button>
                        <button id="username-cancel-btn" class="hidden text-red-500 hover:text-red-600 transition-colors" onclick="cancelEdit('username')" title="Cancel">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Password (Editable) -->
                <div class="space-y-2">
                    <p class="text-sm uppercase tracking-wider text-content-secondary">Password</p>
                    <div class="flex items-center gap-2 group">
                        <p id="password-display" class="text-content-primary">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                        <div id="password-inputs" class="hidden flex-1 space-y-2">
                            <input type="password" id="current-password-input" placeholder="Current password" class="w-full px-3 py-1 bg-primary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent">
                            <input type="password" id="new-password-input" placeholder="New password" class="w-full px-3 py-1 bg-primary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent">
                            <input type="password" id="confirm-password-input" placeholder="Confirm new password" class="w-full px-3 py-1 bg-primary border border-accent rounded text-content-primary focus:outline-none focus:ring-2 focus:ring-accent">
                        </div>
                        <button id="password-edit-btn" class="text-content-secondary hover:text-accent transition-colors opacity-0 group-hover:opacity-100" onclick="editPassword()" title="Change password">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                        <button id="password-save-btn" class="hidden text-accent hover:text-accent- transition-colors" onclick="savePassword()" title="Save">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </button>
                        <button id="password-cancel-btn" class="hidden text-red-500 hover:text-red-600 transition-colors" onclick="cancelPasswordEdit()" title="Cancel">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Admin Status -->
                <div class="space-y-2">
                    <p class="text-sm uppercase tracking-wider text-content-secondary">Admin Status</p>
                    <p class="text-content-primary">{{ 'Yes' if user['is_admin'] else 'No' }}</p>
                </div>
                {% endif %}
            </div>
        </section>

                <!-- Reading Shelves Section -->
        {% if are_friends and reading_lists %}
        <section class="bg-secondary rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-display text-content-primary mb-6">
                {% if is_own_profile %}Your Reading Shelves{% else %}{{ user['username'] }}'s Reading Shelves{% endif %}
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% set statuses = [
                    ('read', 'Read'),
                    ('currently reading', 'Currently Reading'),
                    ('want to read', 'Want to Read'),
                    ('did not finish', 'Did Not Finish')
                ] %}

                {% for status, label in statuses %}
                    <a href="{{ url_for('collections.view_by_status', status=status, username=user['username']) }}"
                       class="group bg-primary hover:bg-primary-hover p-4 rounded-lg transition-all duration-300">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-content-primary text-lg">{{ label }}</span>
                            {% if reading_lists %}
                                {% for list in reading_lists %}
                                    {% if list['status'] == status %}
                                        <span class="bg-accent text-white font-semibold px-3 py-1 rounded-full text-sm">
                                            {{ list['book_count'] }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Book Cover Previews -->
                        {% if reading_list_covers.get(status) %}
                            <div class="flex gap-2 mt-2 truncate">
                                {% for cover_url in reading_list_covers[status][:8] %}
                                    {% if cover_url %}
                                        <img src="{{ url_for('static', filename=cover_url) }}"
                                             alt="Book cover"
                                             class="w-12 h-16 object-cover rounded shadow-sm">
                                    {% else %}
                                        <div class="w-12 h-16 bg-accent/20 rounded flex items-center justify-center">
                                            <svg class="w-6 h-6 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                            </svg>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Reading Goal Section -->
        {% if current_user.id == user['id'] %}
        <section class="bg-secondary rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-display text-content-primary mb-6">{{ current_year }} Reading Goal</h2>

            {% if user['reading_goal'] and user['reading_goal'] > 0 %}
            <div class="space-y-4 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-4xl font-bold text-content-primary">
                            {{ stats.books_read_this_year if stats else 0 }} / {{ user['reading_goal'] }}
                        </p>
                        <p class="text-sm text-content-secondary mt-1">books read this year</p>
                    </div>
                    <div class="text-right">
                        {% set progress = ((stats.books_read_this_year / user['reading_goal']) * 100) if (stats and user['reading_goal'] > 0) else 0 %}
                        <p class="text-3xl font-bold text-accent">{{ "%.0f"|format(progress) }}%</p>
                        <p class="text-sm text-content-secondary">complete</p>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-primary rounded-full h-4 overflow-hidden">
                    {% set progress_width = progress if progress <= 100 else 100 %}
                    <div class="h-full bg-accent rounded-full transition-all duration-500"
                         style="width: {{ progress_width }}%"></div>
                </div>

                <!-- Encouragement message -->
                {% if progress >= 100 %}
                <p class="text-center text-green-400 font-semibold">Congratulations! You've reached your goal!</p>
                {% elif progress >= 75 %}
                <p class="text-center text-content-secondary">You're almost there! Keep going!</p>
                {% elif progress >= 50 %}
                <p class="text-center text-content-secondary">Halfway to your goal!</p>
                {% endif %}
            </div>
            {% else %}
            <p class="text-content-secondary mb-4">Set your annual reading goal to track your progress!</p>
            {% endif %}

            <!-- Update Reading Goal Form -->
            <form method="POST" action="{{ url_for('user.update_reading_goal') }}" class="flex gap-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="number" id="reading_goal" name="reading_goal"
                       value="{{ user['reading_goal'] or 0 }}" min="0"
                       placeholder="How many books do you want to read this year?"
                       class="flex-1 px-4 py-2 bg-primary border border-primary-hover rounded-lg text-content-primary focus:outline-none focus:ring-2 focus:ring-accent">
                <button type="submit"
                        class="px-6 py-2 bg-accent text-white rounded-lg transition-colors hover:bg-accent-hover focus:outline-none focus:ring-2 focus:ring-accent">
                    Update Goal
                </button>
            </form>
            <p class="text-xs text-content-secondary mt-2">Set to 0 to hide the progress tracker</p>
        </section>
        {% endif %}

        <!-- Friends List Section -->
        {% if are_friends %}
        <section class="bg-secondary rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-display text-content-primary">
                    {% if is_own_profile %}Your Friends{% else %}{{ user['username'] }}'s Friends{% endif %}
                </h2>
                {% if is_own_profile %}
                <button id="toggle-friend-search" class="flex items-center gap-2 px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #4f7d19;" onmouseover="this.style.backgroundColor='#6a9839'" onmouseout="this.style.backgroundColor='#4f7d19'" title="Find new friends">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Add Friends</span>
                </button>
                {% endif %}
            </div>

            <!-- Inline Search Bar (hidden by default) -->
            {% if is_own_profile %}
            <div id="friend-search-container" class="hidden mb-4 bg-primary rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg mb-4 font-semibold text-content-primary">Find New Friends</h3>
                    <button id="close-friend-search" class="text-content-secondary hover:text-content-primary transition-colors">
                        <svg class="mb-4 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text"
                           id="friend-search-input"
                           placeholder="Search for users by username..."
                           class="w-full mb-2 px-4 py-2 bg-secondary border border-primary-hover rounded-lg text-content-primary focus:outline-none focus:ring-2 focus:ring-accent"
                           autocomplete="off">
                </div>
                <div id="search-results" class="space-y-2">
                    <p class="text-content-secondary text-center py-4 text-sm">Start typing to search for users...</p>
                </div>
            </div>
            {% endif %}

            {% if friends and friends|length > 0 %}
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                {% for friend in friends %}
                <a href="{{ url_for('user.profile', username=friend.username) }}"
                   class="bg-primary rounded-lg p-2 hover:bg-primary-hover transition-colors flex items-center gap-3">
                    {% if friend.avatar_url %}
                        <img src="{{ url_for('static', filename=friend.avatar_url) }}"
                             alt="{{ friend.username }}"
                             class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                    {% else %}
                        <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-base font-bold text-white flex-shrink-0">
                            {{ friend.username[0].upper() }}
                        </div>
                    {% endif %}
                    <p class="text-content-primary font-medium">{{ friend.username }}</p>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-content-secondary text-center py-8">
                {% if is_own_profile %}
                You don't have any friends yet. Start adding friends to see them here!
                {% else %}
                {{ user['username'] }} doesn't have any friends yet.
                {% endif %}
            </p>
            {% endif %}
        </section>
        {% endif %}

        <!-- Wishlist Section -->
        {% if are_friends and wishlist_books %}
        <section class="bg-secondary rounded-xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-display text-content-primary">
                    {% if is_own_profile %}Your Wishlist{% else %}{{ user['username'] }}'s Wishlist{% endif %}
                </h2>
                {% if is_own_profile %}
                <a href="{{ url_for('wishlist.view_wishlist') }}"
                   class="text-accent hover:text-accent-hover transition-colors text-sm">
                    View all ‚Üí
                </a>
                {% else %}
                <a href="{{ url_for('wishlist.view_user_wishlist', username=user['username']) }}"
                   class="text-accent hover:text-accent-hover transition-colors text-sm">
                    View all ‚Üí
                </a>
                {% endif %}
            </div>

            <!-- Book Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-4">
                {% for book in wishlist_books %}
                <div class="book-item group">
                    <a href="{% if is_own_profile %}{{ url_for('books.show_book', id=book.id) }}{% else %}{{ url_for('books.show_book', id=book.id) }}?wishlist_owner={{ user['username'] }}{% endif %}"
                       class="book-link block h-full bg-primary rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-all duration-200">
                        <div class="book-cover aspect-w-3 aspect-h-4 relative">
                            {% if book.cover_image_url %}
                            <img src="{{ url_for('static', filename=book.cover_image_url) }}"
                                 alt="{{ book.title }}"
                                 class="object-cover w-full h-72 group-hover:opacity-90 transition-opacity duration-200" />
                            {% else %}
                            <div class="flex items-center justify-center h-56 bg-primary text-content-secondary">
                                <svg class="w-12 h-12 text-accent/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                            </div>
                            {% endif %}
                        </div>

                        <div class="book-info p-2">
                            <h3 class="book-title text-sm font-semibold line-clamp-2 mb-1 text-content-primary">
                                {{ book.title }}
                            </h3>
                            <p class="book-author text-content-secondary text-xs">
                                {{ book.author }}
                            </p>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Statistics Tabs Section -->
        {% if stats %}
        <section class="bg-secondary rounded-xl shadow-lg overflow-hidden">
            <!-- Tab Navigation -->
            <div class="flex">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-button active flex-1 px-6 py-4 text-content-primary font-medium transition-colors hover:bg-primary focus:outline-none">
                    Overview
                </button>
                <button onclick="switchTab('insights')" id="tab-insights" class="tab-button flex-1 px-6 py-4 text-content-secondary font-medium transition-colors hover:bg-primary focus:outline-none">
                    Insights
                </button>
                <button onclick="switchTab('library')" id="tab-library" class="tab-button flex-1 px-6 py-4 text-content-secondary font-medium transition-colors hover:bg-primary focus:outline-none">
                    Library
                </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Overview Tab -->
                <div id="content-overview" class="tab-content">
                    <h2 class="text-2xl font-display text-content-primary mb-6">Your Reading Stats</h2>
                    <div class="grid md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Books Read</p>
                            <p class="text-3xl font-bold text-content-primary">{{ stats.books_read or 0 }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Pages Read</p>
                            <p class="text-3xl font-bold text-content-primary">{{ "{:,}".format(stats.pages_read or 0) }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Average Rating</p>
                            <p class="text-3xl font-bold text-content-primary">
                                {{ "%.1f"|format(stats.avg_rating or 0) }}
                                <span class="text-yellow-400">‚òÖ</span>
                            </p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Read Percentage</p>
                            <p class="text-3xl font-bold text-content-primary">{{ stats.read_percentage }}%</p>
                        </div>
                    </div>

                </div>

                <!-- Insights Tab -->
                <div id="content-insights" class="tab-content hidden">
                    <h2 class="text-2xl font-display text-content-primary mb-6">Reading Insights</h2>

                    <!-- Top Genres -->
                    <div class="bg-primary rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-content-primary mb-4">Top Genres</h3>
                        {% if stats.top_genres and stats.top_genres|length > 0 %}
                        <div class="space-y-3">
                            {% for genre in stats.top_genres %}
                            <div class="flex items-center gap-2 p-4 mb-4 bg-secondary rounded-lg">
                                <div class="flex-1">
                                    <p class="font-medium text-content-primary">{{ genre.genre }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <p class="text-lg font-semibold text-accent">{{ genre.count }} book{{ 's' if genre.count > 1 else '' }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-content-secondary text-center py-8">No genre data available yet. Start reading books with genres!</p>
                        {% endif %}
                    </div>

                    <!-- Collection Status -->
                    <div class="bg-primary rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-content-primary mb-4">Collection Status</h3>
                        {% if stats.collection_status and stats.collection_status|length > 0 %}
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {% for status in stats.collection_status %}
                            <div class="bg-secondary rounded-lg p-4 text-center">
                                <p class="text-sm text-content-secondary mb-1">{{ status.status.capitalize() }}</p>
                                <p class="text-3xl font-bold text-accent">{{ status.count }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-content-secondary text-center py-8">No collection data available yet.</p>
                        {% endif %}
                    </div>

                    <!-- Top Authors -->
                    <div class="bg-primary rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-content-primary mb-4">Top Authors</h3>
                        {% if stats.top_authors and stats.top_authors|length > 0 %}
                        <div class="space-y-3">
                            {% for author in stats.top_authors %}
                            <div class="flex items-center gap-2 p-4 mb-4 bg-secondary rounded-lg">
                                <div class="flex-1">
                                    <p class="font-medium text-content-primary">{{ author.author }}</p>
                                    <p class="text-sm text-content-secondary">{{ author.books_count }} book{{ 's' if author.books_count > 1 else '' }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <p class="text-lg font-semibold text-accent">
                                        {{ author.avg_rating or 'N/A' }}
                                        {% if author.avg_rating %}<span class="text-yellow-400">‚òÖ</span>{% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-content-secondary text-center py-8">No author data available yet. Start reading and rating books!</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Library Tab -->
                <div id="content-library" class="tab-content hidden">
                    {% if library_stats %}
                    <h2 class="text-2xl font-display text-content-primary mb-6">Library Statistics</h2>
                    <div class="grid md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Total Books</p>
                            <p class="text-3xl font-bold text-content-primary">{{ library_stats.total_books }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Total Pages</p>
                            <p class="text-3xl font-bold text-content-primary">{{ library_stats.total_pages }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Unique Authors</p>
                            <p class="text-3xl font-bold text-content-primary">{{ library_stats.unique_authors }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Longest Book</p>
                            <p class="text-xl font-bold text-content-primary">{{ library_stats.longest_book }}</p>
                        </div>
                        <div class="bg-primary rounded-lg p-4">
                            <p class="text-sm text-content-secondary mb-1">Most Common Genre</p>
                            <p class="text-xl font-bold text-content-primary">{{ library_stats.most_common_genre }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Export Button -->
        <div class="flex justify-center">
            <a href="{{ url_for('user.export_library') }}"
               class="inline-flex items-center gap-2 px-6 py-3 bg-accent rounded-lg text-white transition-colors hover:bg-accent-hover">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                </svg>
                Export Library to CSV
            </a>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.classList.remove('text-content-primary');
                button.classList.add('text-content-secondary');
            });

            // Show selected tab content
            document.getElementById('content-' + tabName).classList.remove('hidden');

            // Activate selected tab button
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('active', 'text-content-primary');
            activeButton.classList.remove('text-content-secondary');
        }
    </script>
    <script>
        // Inline editing functionality
        function editField(fieldName) {
            const display = document.getElementById(`${fieldName}-display`);
            const input = document.getElementById(`${fieldName}-input`);
            const editBtn = document.getElementById(`${fieldName}-edit-btn`);
            const saveBtn = document.getElementById(`${fieldName}-save-btn`);
            const cancelBtn = document.getElementById(`${fieldName}-cancel-btn`);

            // Hide display and edit button, show input and action buttons
            display.classList.add('hidden');
            editBtn.classList.add('hidden');
            input.classList.remove('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');

            // Focus the input
            input.focus();
            input.select();
        }

        function cancelEdit(fieldName) {
            const display = document.getElementById(`${fieldName}-display`);
            const input = document.getElementById(`${fieldName}-input`);
            const editBtn = document.getElementById(`${fieldName}-edit-btn`);
            const saveBtn = document.getElementById(`${fieldName}-save-btn`);
            const cancelBtn = document.getElementById(`${fieldName}-cancel-btn`);

            // Reset input to original value
            input.value = display.textContent;

            // Show display and edit button, hide input and action buttons
            display.classList.remove('hidden');
            editBtn.classList.remove('hidden');
            input.classList.add('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }

        async function saveField(fieldName) {
            const input = document.getElementById(`${fieldName}-input`);
            const newValue = input.value.trim();

            if (!newValue) {
                alert(`${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} cannot be empty!`);
                return;
            }

            // Basic email validation
            if (fieldName === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(newValue)) {
                    alert('Please enter a valid email address!');
                    return;
                }
            }

            try {
                const response = await fetch(`/user/update_${fieldName}`, {
                    method: 'POST',
                    headers: getCSRFHeaders(),
                    body: JSON.stringify({ [fieldName]: newValue })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update the display text
                    const display = document.getElementById(`${fieldName}-display`);
                    display.textContent = newValue;

                    // Exit edit mode
                    cancelEdit(fieldName);

                    // Show success message
                    showFlashMessage('success', data.message || `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} updated successfully!`);

                    // If username was changed, redirect to new profile URL
                    if (fieldName === 'username') {
                        setTimeout(() => {
                            window.location.href = `/user/${newValue}`;
                        }, 1000);
                    }
                } else {
                    alert(data.message || `Failed to update ${fieldName}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`An error occurred while updating ${fieldName}`);
            }
        }

        // Note: showFlashMessage is now defined in _flash_messages.html
        // No need to redefine it here

        // Password editing functions
        function editPassword() {
            const display = document.getElementById('password-display');
            const inputs = document.getElementById('password-inputs');
            const editBtn = document.getElementById('password-edit-btn');
            const saveBtn = document.getElementById('password-save-btn');
            const cancelBtn = document.getElementById('password-cancel-btn');

            // Hide display and edit button, show inputs and action buttons
            display.classList.add('hidden');
            editBtn.classList.add('hidden');
            inputs.classList.remove('hidden');
            saveBtn.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');

            // Focus the first input
            document.getElementById('current-password-input').focus();
        }

        function cancelPasswordEdit() {
            const display = document.getElementById('password-display');
            const inputs = document.getElementById('password-inputs');
            const editBtn = document.getElementById('password-edit-btn');
            const saveBtn = document.getElementById('password-save-btn');
            const cancelBtn = document.getElementById('password-cancel-btn');

            // Clear all password inputs
            document.getElementById('current-password-input').value = '';
            document.getElementById('new-password-input').value = '';
            document.getElementById('confirm-password-input').value = '';

            // Show display and edit button, hide inputs and action buttons
            display.classList.remove('hidden');
            editBtn.classList.remove('hidden');
            inputs.classList.add('hidden');
            saveBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
        }

        async function savePassword() {
            const currentPassword = document.getElementById('current-password-input').value;
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;

            // Validation
            if (!currentPassword) {
                alert('Please enter your current password');
                return;
            }

            if (!newPassword) {
                alert('Please enter a new password');
                return;
            }

            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            try {
                const response = await fetch('/user/update_password', {
                    method: 'POST',
                    headers: getCSRFHeaders(),
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Exit edit mode
                    cancelPasswordEdit();

                    // Show success message
                    showFlashMessage('success', data.message || 'Password updated successfully!');
                } else {
                    alert(data.message || 'Failed to update password');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating password');
            }
        }

        // Avatar upload function
        async function uploadAvatar(event) {
            const file = event.target.files[0];
            console.log('uploadAvatar called', file);

            if (!file) {
                console.log('No file selected');
                return;
            }

            console.log('File info:', {
                name: file.name,
                size: file.size,
                type: file.type
            });

            // Validate file type
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please upload a valid image file (PNG, JPG, GIF, or WebP)');
                return;
            }

            // Show loading text
            const statusText = document.getElementById('avatar-upload-status');
            if (statusText) {
                statusText.classList.remove('hidden');
            }

            // Create FormData and append file
            const formData = new FormData();
            formData.append('avatar', file);
            addCSRFToFormData(formData); // Add CSRF token
            console.log('FormData created with file and CSRF token');

            try {
                console.log('Sending upload request to /user/upload_avatar');

                const response = await fetch('/user/upload_avatar', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok && data.success) {
                    console.log('Upload successful, avatar URL:', data.avatar_url);

                    // Hide status text
                    if (statusText) {
                        statusText.classList.add('hidden');
                    }

                    // Update avatar display
                    const avatarImage = document.getElementById('avatar-image');
                    const avatarPlaceholder = document.getElementById('avatar-placeholder');

                    if (avatarImage) {
                        // Update existing image with cache bust
                        console.log('Updating existing avatar image');
                        avatarImage.src = data.avatar_url + '?t=' + new Date().getTime();
                    } else if (avatarPlaceholder) {
                        // Replace placeholder with image
                        console.log('Replacing placeholder with new image');
                        const newImg = document.createElement('img');
                        newImg.id = 'avatar-image';
                        newImg.src = data.avatar_url;
                        newImg.alt = '{{ user["username"] }}';
                        newImg.className = 'w-full h-full rounded-full object-cover';
                        newImg.style.width = '64px';
                        newImg.style.height = '64px';
                        avatarPlaceholder.replaceWith(newImg);
                    }

                    // Update all other avatar instances on page without reload
                    const sidebarAvatar = document.querySelector('.sidebar-avatar');
                    if (sidebarAvatar) {
                        sidebarAvatar.src = data.avatar_url + '?t=' + new Date().getTime();
                    }

                    // Show success message
                    showFlashMessage('success', data.message || 'Profile picture updated successfully!');
                } else {
                    console.error('Upload failed:', data.message);
                    alert(data.message || 'Failed to upload profile picture');

                    // Hide status text on error
                    if (statusText) {
                        statusText.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('An error occurred while uploading profile picture: ' + error.message);

                // Hide status text on error
                if (statusText) {
                    statusText.classList.add('hidden');
                }
            }

            // Reset file input
            event.target.value = '';
        }

        // Bio editing functions
        function editBio() {
            const displayContainer = document.getElementById('bio-display-container');
            const editContainer = document.getElementById('bio-edit-container');
            const editBtn = document.getElementById('bio-edit-btn');
            const input = document.getElementById('bio-input');

            displayContainer.classList.add('hidden');
            editContainer.classList.remove('hidden');
            editBtn.classList.add('hidden');

            // Update character count
            updateCharCount();

            // Focus the textarea
            input.focus();
        }

        function cancelBioEdit() {
            const displayContainer = document.getElementById('bio-display-container');
            const editContainer = document.getElementById('bio-edit-container');
            const editBtn = document.getElementById('bio-edit-btn');
            const input = document.getElementById('bio-input');
            const display = document.getElementById('bio-display');

            // Reset textarea to original value
            input.value = '{{ user["bio"] if user["bio"] else "" }}'.replace(/&#34;/g, '"').replace(/&#39;/g, "'");

            displayContainer.classList.remove('hidden');
            editContainer.classList.add('hidden');
            editBtn.classList.remove('hidden');
        }

        async function saveBio() {
            const input = document.getElementById('bio-input');
            const newBio = input.value.trim();

            if (newBio.length > 500) {
                alert('Bio must be 500 characters or less!');
                return;
            }

            try {
                const response = await fetch('/user/update_bio', {
                    method: 'POST',
                    headers: getCSRFHeaders(),
                    body: JSON.stringify({ bio: newBio })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update the display text
                    const display = document.getElementById('bio-display');
                    display.textContent = newBio || 'Add a bio to tell others about yourself...';

                    // Exit edit mode
                    cancelBioEdit();

                    // Show success message
                    showFlashMessage('success', data.message || 'Bio updated successfully!');
                } else {
                    alert(data.message || 'Failed to update bio');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating bio');
            }
        }

        function updateCharCount() {
            const input = document.getElementById('bio-input');
            const charCount = document.getElementById('bio-char-count');
            const count = input.value.length;
            charCount.textContent = `${count} / 500`;
        }

        // Add event listener for character count
        const bioInput = document.getElementById('bio-input');
        if (bioInput) {
            bioInput.addEventListener('input', updateCharCount);
            // Initialize count on page load
            updateCharCount();
        }

        // Friend search inline toggle functionality
        const toggleBtn = document.getElementById('toggle-friend-search');
        const closeBtn = document.getElementById('close-friend-search');
        const searchContainer = document.getElementById('friend-search-container');
        const searchInput = document.getElementById('friend-search-input');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;

        // Toggle search container
        if (toggleBtn && searchContainer) {
            toggleBtn.addEventListener('click', function() {
                searchContainer.classList.toggle('hidden');
                if (!searchContainer.classList.contains('hidden')) {
                    // Focus the search input when opening
                    setTimeout(() => {
                        if (searchInput) searchInput.focus();
                    }, 100);
                }
            });
        }

        // Close search container
        if (closeBtn && searchContainer) {
            closeBtn.addEventListener('click', function() {
                searchContainer.classList.add('hidden');
                if (searchInput) {
                    searchInput.value = '';
                    searchResults.innerHTML = '<p class="text-content-secondary text-center py-4 text-sm">Start typing to search for users...</p>';
                }
            });
        }

        // Search functionality
        if (searchInput && searchResults) {
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    searchResults.innerHTML = '<p class="text-content-secondary text-center py-4 text-sm">Start typing to search for users...</p>';
                    return;
                }

                searchResults.innerHTML = '<p class="text-content-secondary text-center py-4 text-sm">Searching...</p>';

                searchTimeout = setTimeout(() => {
                    fetch(`/friends/search_users?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(users => {
                            if (users.length === 0) {
                                searchResults.innerHTML = '<p class="text-content-secondary text-center py-4 text-sm">No users found</p>';
                            } else {
                                searchResults.innerHTML = users.map(user => {
                                    const avatarHtml = user.avatar_url
                                        ? `<img src="/static/${user.avatar_url}" alt="${user.username}" class="w-10 h-10 rounded-full object-cover">`
                                        : `<div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-base font-bold text-white">${user.username[0].toUpperCase()}</div>`;

                                    let actionHtml = '';
                                    if (user.friendship_status === 'friends') {
                                        actionHtml = '<span class="text-sm text-green-500">‚úì Friends</span>';
                                    } else if (user.friendship_status === 'request_sent') {
                                        actionHtml = '<span class="text-sm text-content-secondary">Request Sent</span>';
                                    } else if (user.friendship_status === 'request_received') {
                                        actionHtml = '<span class="text-sm text-blue-500">Request Received</span>';
                                    } else {
                                        actionHtml = `<form method="POST" action="/friends/send_request/${user.username}" class="inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="px-3 py-1 text-white rounded text-sm transition-colors" style="background-color: #4f7d19;" onmouseover="this.style.backgroundColor='#6a9839'" onmouseout="this.style.backgroundColor='#4f7d19'">
                                                Add Friend
                                            </button>
                                        </form>`;
                                    }

                                    return `
                                        <div class="p-2 mt-2 hover:bg-primary transition-colors rounded-lg">
                                            <div class="flex items-center justify-between gap-3">
                                                <a href="/user/${user.username}" class="flex items-center gap-3 flex-1">
                                                    ${avatarHtml}
                                                    <div>
                                                        <p class="text-content-primary font-medium">${user.username}</p>
                                                    </div>
                                                </a>
                                                <div class="flex-shrink-0">
                                                    ${actionHtml}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            }
                        })
                        .catch(error => {
                            console.error('Search error:', error);
                            searchResults.innerHTML = '<p class="text-red-500 text-center py-4 text-sm">Error searching users</p>';
                        });
                }, 300);
            });
        }
    </script>
</body>
</html>